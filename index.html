<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>物件マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Mapbox -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

<!-- 日本語化 -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js"></script>

<style>
body{margin:0;}
#map{width:100vw;height:100vh;}
#userStatus{
 position:absolute;
 z-index:10;
 background:#fff;
 padding:6px 10px;
 margin:10px;
 font-size:14px;
}
</style>
</head>

<body>

<div id="userStatus">ログアウト中</div>
<div id="authBox" style="
  position:absolute;
  z-index:10;
  right:10px;
  top:10px;
  background:#fff;
  padding:10px;
  border:1px solid #ddd;
  font-size:14px;
">
  <div style="margin-bottom:6px;">管理者ログイン</div>
  <input id="email" type="email" placeholder="メール" style="width:200px;"><br><br>
  <input id="password" type="password" placeholder="パスワード" style="width:200px;"><br><br>
  <button onclick="doLogin()">ログイン</button>
  <button onclick="doLogout()">ログアウト</button>
</div>

<div id="map"></div>

<script>
// ===== Supabase =====
const SUPABASE_URL='https://ahlgfkvqqckkxftwvgqn.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFobGdma3ZxcWNra3hmdHd2Z3FuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjYzNjcsImV4cCI6MjA4NjQ0MjM2N30.L2JpsadBNs-7ntVM_tYjcedL9TkL8nRfV8tXDG5G5xQ';

if(!window.sb){
 window.sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
}

const sb=window.sb;
let currentUser=null;
const status=document.getElementById('userStatus');
async function doLogin(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){
    alert('ログイン失敗: ' + error.message);
  }else{
    alert('ログイン成功');
  }
}

async function doLogout(){
  await sb.auth.signOut();
  alert('ログアウトしました');
}


sb.auth.getSession().then(({data})=>{
 if(data.session&&data.session.user){
  currentUser=data.session.user;
  status.innerText='ログイン中';
 }
});

sb.auth.onAuthStateChange((e,s)=>{
 if(s&&s.user){
  currentUser=s.user;
  status.innerText='ログイン中';
 }else{
  currentUser=null;
  status.innerText='ログアウト中';
 }
});

// ===== Mapbox =====
mapboxgl.accessToken='pk.eyJ1IjoidG9saWxpZW4iLCJhIjoiY21saXZ3NmN5MDFsdTNkcHVwNHJxcGk2MyJ9.KB63e24JsvfckeEz2WRcNw';

const map=new mapboxgl.Map({
 container:'map',
 style:'mapbox://styles/mapbox/streets-v11',
 center:[139.767,35.681],
 zoom:12
});

// ★エラー防止（missing image対策）
map.on('styleimagemissing',e=>{
 const img=new ImageData(1,1);
 if(!map.hasImage(e.id)) map.addImage(e.id,img);
});

// 日本語表示
map.addControl(new MapboxLanguage({defaultLanguage:'ja'}));

// ピン追加（ログイン時のみ）
map.on('click',e=>{
 if(!currentUser){
  alert('管理者ログインが必要です');
  return;
 }

 const text=prompt('内容を入力してください');
 if(!text)return;

 new mapboxgl.Marker({color:'red'})
  .setLngLat(e.lngLat)
  .setPopup(new mapboxgl.Popup().setText(text))
  .addTo(map);
});
</script>

</body>
</html>
