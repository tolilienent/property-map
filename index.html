<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>物件マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js"></script>

<style>
body{margin:0;}
#map{width:100vw;height:100vh;}
#userStatus{
 position:absolute;
 z-index:10;
 background:#fff;
 padding:6px 10px;
 margin:10px;
 font-size:14px;
}
#authBox{
 position:absolute;
 z-index:10;
 right:10px;
 top:10px;
 background:#fff;
 padding:10px;
 border:1px solid #ddd;
}
</style>
</head>

<body>

<div id="userStatus">確認中...</div>

<div id="authBox">
<input id="email" placeholder="メール"><br><br>
<input id="password" type="password" placeholder="パスワード"><br><br>
<button onclick="login()">ログイン</button>
<button onclick="logout()">ログアウト</button>
</div>

<div id="map"></div>

<script>
/* ===== Supabase ===== */
const sb = supabase.createClient(
 'https://ahlgfkvqqckkxftwvgqn.supabase.co',
 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFobGdma3ZxcWNra3hmdHd2Z3FuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjYzNjcsImV4cCI6MjA4NjQ0MjM2N30.L2JpsadBNs-7ntVM_tYjcedL9TkL8nRfV8tXDG5G5xQ',
 {
  auth:{
   persistSession:true,
   autoRefreshToken:true,
   storage:localStorage
  }
 });

let user=null;
const status=document.getElementById('userStatus');

async function refresh(){
 const {data}=await sb.auth.getSession();
 user=data.session?.user||null;
 status.innerText=user?'ログイン中':'ログアウト中';
}

async function login(){
 const {error}=await sb.auth.signInWithPassword({
  email:email.value,
  password:password.value
 });
 if(error)alert(error.message);
 refresh();
}

async function logout(){
 await sb.auth.signOut();
 refresh();
}

sb.auth.onAuthStateChange(refresh);

/* ===== Mapbox ===== */
mapboxgl.accessToken='pk.eyJ1IjoidG9saWxpZW4iLCJhIjoiY21saXZ3NmN5MDFsdTNkcHVwNHJxcGk2MyJ9.KB63e24JsvfckeEz2WRcNw';

const map=new mapboxgl.Map({
 container:'map',
 style:'mapbox://styles/mapbox/streets-v11',
 center:[139.767,35.681],
 zoom:12
});

map.addControl(new MapboxLanguage({defaultLanguage:'ja'}));

const markers=[];

function draw(p){
 new mapboxgl.Marker({color:'red'})
  .setLngLat([p.lng,p.lat])
  .setPopup(new mapboxgl.Popup().setText(p.title))
  .addTo(map);
}

async function loadPins(){
 const {data}=await sb.from('pins').select('*');
 markers.forEach(m=>m.remove());
 data?.forEach(draw);
}

map.on('load',loadPins);

map.on('click',async e=>{
 if(!user){alert('ログイン必要');return;}
 const t=prompt('内容');
 if(!t)return;

 const {data,error}=await sb
  .from('pins')
  .insert([{title:t,lat:e.lngLat.lat,lng:e.lngLat.lng}])
  .select()
  .single();

 if(error){alert(error.message);return;}
 draw(data);
});

refresh();
</script>
</body>
</html>
